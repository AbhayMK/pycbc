#! /usr/bin/env python

import os
import sqlite3
from optparse import OptionParser
import math
import numpy
from pycbc import plot
from pycbc.plot import plot_utils

parser = OptionParser()
parser.add_option('-c', '--cache-file', help = 'cache file containing result databases')
parser.add_option('-W', '--weight-function', default='uniform', help="Get effectualness for the given weight function. Default is 'uniform'. The weight name provided must exist in the description column of the coinc_definer table.")
parser.add_option('-P', '--apply-cut', action = 'append', default = [], metavar = 'arg:min,max', help = 'apply cut to injections; can specify multiple times')
parser.add_option('-t', '--plot-templates', action = 'store_true', default = False, help = 'plot the templates on top of the results')
parser.add_option('-x', '--x-val', metavar = 'args:label', help = 'x value to plot')
parser.add_option('-y', '--y-val', metavar = 'args:label', help = 'y value to plot')
parser.add_option('--log-x', action='store_true', default=False, help='Make x-axis log10.')
parser.add_option('--log-y', action='store_true', default=False, help='Make y-axis log10.')
parser.add_option('-X', '--x-lims', metavar = 'xmin,xmax', help = 'x limits to use')
parser.add_option('-Y', '--y-lims', metavar = 'ymin,ymax', help = 'y limits to use')
parser.add_option('-Z', '--z-lims', metavar = 'zmin,zmax', help = 'limits to use')
parser.add_option('-T', '--tmplt-label', default='', help='set a label for the templates. This will be placed in leading subscript in the colorbar label.')
parser.add_option('-I', '--inj-label', default='', help='set a label for the injections. This will be placed in trailing subscript in the colorbar label.')
parser.add_option('', '--point-size', type = 'int', default = 3, help = 'Size to use for points; default is 3.')
parser.add_option('-o', '--output-dir', default='.', help = 'directory to save plot(s) to')
parser.add_option('-u', '--user-tag', help = 'set a user tag for output file names')
parser.add_option('', '--plot-type', default = 'png', help = 'type of plot to create; default is png')
parser.add_option('', '--dpi', type='int', default=300, help='DPI to use for plot. Default is 300.')
parser.add_option('', '--cmap', default='Reds', help='Color map to use for points. Options are %s. Default is Reds.' %(', '.join(plot.pyplot.cm._cmapnames)))
parser.add_option('', '--bkg-color', default='k', help='Set the background color for the axis. Default is "k" (black).')
parser.add_option('', '--save-data', action='store_true', default=False, help='Save the plotting data to a pickle file. The file will have the same name as the output plot, but with a .pickle extension.')

opts, _ = parser.parse_args()

xarg, xlabel = opts.x_val.split(':')
yarg, ylabel = opts.y_val.split(':')
if opts.x_lims is not None:
    xmin, xmax = map(float, opts.x_lims.split(','))
else:
    xmin, xmax = (None, None)
if opts.y_lims is not None:
    ymin, ymax = map(float, opts.y_lims.split(','))
else:
    ymin, ymax = (None, None)
if opts.z_lims is not None:
    zmin, zmax = map(float, opts.z_lims.split(','))
else:
    zmin, zmax = (None, None)
if opts.user_tag is not None:
    tag = '_%s' % opts.user_tag
else:
    tag = ''


print "getting results"
filenames = plot_utils.parse_results_cache(opts.cache_file)
inj_results, _ = plot_utils.get_injection_results(filenames,
    weight_function=opts.weight_function, get_inj_map=False, verbose=True)
apply_cut = {}
for thiscut in opts.apply_cut:
    arg, vals = thiscut.split(':')
    apply_cut[arg] = map(float, vals.split(','))
if apply_cut:
    print "applying cuts"
    inj_results = plot_utils.slice_results(inj_results, apply_cut)
if opts.plot_templates:
    print "getting templates"
    ii = 0
    templates = []
    while not templates:
        try:
            templates = plot_utils.get_templates(filenames[ii])
        except:
            pass
        ii += 1
        if ii >= len(filenames):
            break

else:
    templates = []

print "plotting..."
for apprx, results in inj_results.items():
    print "\t%s" % apprx
    fig, _, plot_data = plot.plot_effectualness(results, xarg,
        xlabel, yarg, ylabel, opts.tmplt_label, opts.inj_label,
        logx=opts.log_x, logy=opts.log_y,
        plot_templates=opts.plot_templates, templates=templates, xmin=xmin,
        xmax=xmax, ymin=ymin, ymax=ymax, zmin=zmin, zmax=zmax,
        ptsize=opts.point_size, cmap=opts.cmap, bkgclr=opts.bkg_color, dpi=300)

    fig.savefig('%s/plot_effectualness%s-%s.%s' %(opts.output_dir, tag, apprx,
        opts.plot_type), dpi=opts.dpi, bbox_inches='tight')
